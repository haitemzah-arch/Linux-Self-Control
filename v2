#!/usr/bin/env python3

# ============================================================
# ğŸ” Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù‚ÙÙ„Ø© (Immutable Files Log) ğŸ”
# ÙÙŠ Ø­Ø§Ù„ Ø£Ø±Ø¯Øª ÙÙƒ Ø§Ù„Ù‚ÙÙ„ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ´Ù…ÙŠØ¹Ù‡Ø§:
#
# 1. Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª (Ø§Ù„Ø­Ø§Ø±Ø³):
#    /usr/local/bin/sys-core.py
#
# 2. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Autostart):
#    /home/newuser/.config/autostart/system-guardian.desktop
#
# 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ø¥Ù†ØªØ±Ù†Øª (Network & DNS):
#    /etc/resolv.conf
#    /etc/netplan/*.yaml
#    /etc/NetworkManager/system-connections/
#    /etc/hosts
#    /etc/nextdns.conf
#
# 4. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø© (System & GUI):
#    /etc/gdm3/custom.conf
#    /etc/brave/policies/managed/force_unhook.json
# 5. Ø¥ØºÙ„Ø§Ù‚ Ø«ØºØ±Ø© Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ (TTY / Virtual Consoles):
#    - ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØªÙŠØ±Ù…Ù†Ø§Ù„: systemctl mask getty@tty2...tty6
#    - ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: /etc/systemd/logind.conf
#    - Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: (NAutoVTs=1) Ùˆ (ReserveVT=1) Ù„Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø© ÙˆØ§Ø­Ø¯Ø©.
#    - Ø§Ù„Ù…Ù„Ù Ù…Ù‚ÙÙ„: /etc/systemd/logind.conf

# ============================================================

# -*- coding: utf-8 -*-
"""
Guardian Script v3.0 - Ultimate Edition with Logging
Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„:
1. ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (ÙŠØ­ÙˆÙ„ "Ø¨Ù†Øª" Ø¥Ù„Ù‰ "fkj" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙŠÙƒØªØ´ÙÙ‡Ø§).
2. ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù†Ø³Ø® Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (Ø§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø£ÙˆØ³Ø·).
3. ÙŠØºÙ„Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø¨Ù‚ÙˆØ©.
4. ÙŠØ´Ù…Ù„ ÙƒÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.
5. ÙŠØ³Ø¬Ù„ ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ù…Ù„Ù zzza.txt
"""

import subprocess
import threading
import time
import re
import signal
import sys
import os
from datetime import datetime

# ============================================================
# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ù€ Log
# ============================================================

LOG_FILE = "zzza.txt"

def log_message(message):
    """ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù€ log Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®"""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    log_entry = f"[{timestamp}] {message}\n"
    
    # Ø·Ø¨Ø§Ø¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
    print(log_entry.strip())
    
    # ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù
    try:
        with open(LOG_FILE, 'a', encoding='utf-8') as f:
            f.write(log_entry)
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù„Ù„Ù…Ù„Ù: {e}")

# ============================================================
# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
# ============================================================

def check_dependencies():
    missing_libs = []
    missing_tools = []
    
    try:
        from pynput import keyboard
    except ImportError:
        missing_libs.append("pynput")
    
    try:
        import pyperclip
    except ImportError:
        missing_libs.append("pyperclip")
        
    if subprocess.call(["which", "xsel"], stdout=subprocess.DEVNULL) != 0:
        missing_tools.append("xsel")
    
    if subprocess.call(["which", "xdotool"], stdout=subprocess.DEVNULL) != 0:
        missing_tools.append("xdotool")

    if missing_libs or missing_tools:
        log_message("=" * 60)
        log_message("âš ï¸  ØªÙ†Ø¨ÙŠÙ‡: Ø£Ø¯ÙˆØ§Øª Ù…ÙÙ‚ÙˆØ¯Ø©!")
        if missing_libs:
            log_message(f"Ù…ÙƒØªØ¨Ø§Øª Ø¨Ø§ÙŠØ«ÙˆÙ†: sudo apt install python3-pynput python3-pyperclip")
        if missing_tools:
            log_message(f"Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…: sudo apt install {' '.join([t.split()[0] for t in missing_tools])}")
        log_message("=" * 60)
        sys.exit(1)

log_message("ğŸš€ Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª...")
check_dependencies()
log_message("âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…ØªÙˆÙØ±Ø©")

from pynput import keyboard
import pyperclip

# ============================================================
# Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
# ============================================================

# ğŸ”´ ØºÙŠØ± Ù‡Ø°Ø§ Ø¥Ù„Ù‰ False Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ø­Ø¸Ø± ÙØ¹Ù„ÙŠØ§Ù‹ ÙˆÙŠØºÙ„Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ°
TEST_MODE = True

# Ø­Ø¬Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù„ÙƒØªØ§Ø¨Ø©
BUFFER_SIZE = 500

# Ø³Ø±Ø¹Ø© Ø§Ù„ÙØ­Øµ (Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ)
CLIPBOARD_CHECK_INTERVAL = 0.5

log_message(f"âš™ï¸  Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: TEST_MODE={TEST_MODE}, BUFFER_SIZE={BUFFER_SIZE}")

# ============================================================
# Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ Ù„Ù…Ø´ÙƒÙ„Ø© fkj)
# ============================================================

# Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªØ­ÙˆÙ„ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ù„Ù‡ ÙÙŠ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ
AR_TO_EN_MAP = {
    'Ø§': 'h', 'Ø¨': 'f', 'Øª': 'j', 'Ø«': 'e', 'Ø¬': '[', 'Ø­': 'p', 'Ø®': 'o', 
    'Ø¯': ']', 'Ø°': '`', 'Ø±': 'v', 'Ø²': '.', 'Ø³': 's', 'Ø´': 'a', 'Øµ': 'w', 
    'Ø¶': 'q', 'Ø·': "'", 'Ø¸': '/', 'Ø¹': 'u', 'Øº': 'y', 'Ù': 't', 'Ù‚': 'r', 
    'Ùƒ': ';', 'Ù„': 'g', 'Ù…': 'l', 'Ù†': 'k', 'Ù‡': 'i', 'Ùˆ': ',', 'ÙŠ': 'd', 
    'Ø©': 'm', 'Ù‰': 'n', 'Ø¤': 'c', 'Ø¦': 'z', 'Ø¡': 'x', 'Ù„Ø§': 'b', 'Ø¢': 'h', 
    'Ø¥': 'h', 'Ø£': 'h'
}

# ============================================================
# Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£Ø­Ø±Ù (Ù„Ù„ØªØ­Ø§ÙŠÙ„)
# ============================================================

CHAR_REPLACEMENTS = {
    '0': 'o', '1': 'l', '3': 'e', '4': 'a', '5': 's',
    '6': 'g', '7': 't', '8': 'b', '9': 'g',
    '@': 'a', '$': 's', '!': 'i', '(': 'c', ')': 'c',
    '+': 't', '|': 'l', '*': 'a', '#': 'h',
    'Ø£': 'Ø§', 'Ø¥': 'Ø§', 'Ø¢': 'Ø§', 'Ø©': 'Ù‡', 'Ù‰': 'ÙŠ', 'Ø¦': 'ÙŠ', 'Ø¤': 'Ùˆ',
}

ARABIC_NOISE = re.compile(r'[\u064B-\u065F\u0640\u06D4\u06D5-\u06ED]')

# ============================================================
# Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ø´Ø§Ù…Ù„Ø©
# ============================================================

# 1. Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ© (Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù…Ù†Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
PORN_WORDS_BASE = [
    "girl", "girls", "woman", "women", "wrestling", "mixed", "mixedwrestling",
    "Ø¨Ù†Øª", "Ø¨Ù†Ø§Øª", "Ø§Ù„Ø¨Ù†Øª", "Ø§Ù„Ø¨Ù†Ø§Øª", "Ø¨Ù†ÙˆØª", "Ø¨Ù†ÙˆØªØ©", "Ø¨Ù†ÙˆØªÙ‡", "Ø¨Ù†ÙŠØ§Øª", 
    "Ø§Ù…Ø±Ø§Ø©", "Ø§Ù…Ø±Ø§Ù‡", "Ø§Ù…Ø±Ø£Ø©", "Ø§Ù…Ø±Ø£Ù‡", "Ø¥Ù…Ø±Ø§Ø©", "Ø¥Ù…Ø±Ø§Ù‡", "Ø¥Ù…Ø±Ø£Ø©", "Ø¥Ù…Ø±Ø£Ù‡",
    "Ù…Ø±Ø§Ø©", "Ù…Ø±Ø§Ù‡", "Ù…Ø±Ø£Ø©", "Ù…Ø±Ø£Ù‡", "Ø§Ù„Ù…Ø±Ø§Ø©", "Ø§Ù„Ù…Ø±Ø§Ù‡", "Ø§Ù„Ù…Ø±Ø£Ø©", "Ø§Ù„Ù…Ø±Ø£Ù‡",
    "Ø§Ù…Ø±Ù‡", "Ø§Ù…Ø±Ø©", "Ù…Ø±Ù‡", "Ù…Ø±Ø©",
    "Ù†Ø³Ø§Ø¡", "Ø§Ù„Ù†Ø³Ø§Ø¡", "Ù†Ø³ÙˆØ©", "Ù†Ø³ÙˆØ§Ù†", "Ù†Ø³Ø§", "Ø§Ù„Ù†Ø³Ø§", "Ù†Ø³ÙˆÙ‡",
    "Ù…ØµØ§Ø±Ø¹Ø©", "Ø§Ù„Ù…ØµØ§Ø±Ø¹Ø©", "Ù…ØµØ§Ø±Ø¹Ù‡", "Ø§Ù„Ù…ØµØ§Ø±Ø¹Ù‡",
    "Ù…Ø®ØªÙ„Ø·Ø©", "Ø§Ù„Ù…Ø®ØªÙ„Ø·Ø©", "Ù…Ø®ØªÙ„Ø·Ù‡", "Ø§Ù„Ù…Ø®ØªÙ„Ø·Ù‡",
    "Ø³Øª", "Ø§Ù„Ø³Øª", "Ø³ØªØ§Øª", "Ø­Ø±ÙŠÙ…", "Ø§Ù„Ø­Ø±ÙŠÙ…",
]

# 2. Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø®Ø·ÙŠØ±Ø©
DANGEROUS_INSTALL_COMMANDS = [
    "apt install e2fsprogs", "apt-get install e2fsprogs", "apt reinstall e2fsprogs",
    "apt install --reinstall e2fsprogs", "aptitude install e2fsprogs",
    "dpkg -i e2fsprogs", "dpkg --install e2fsprogs",
    "apt install busybox", "apt-get install busybox", "apt install busybox-static",
    "snap install busybox", "apt install attr", "apt-get install attr",
    "apt install util-linux", "wget chattr", "curl chattr", "wget e2fsprogs",
    "curl e2fsprogs", "wget busybox", "curl busybox",
    "pip install uchattr", "pip3 install uchattr",
]

# 3. Ø£ÙˆØ§Ù…Ø± Ù‚ØªÙ„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª
KILL_SCRIPT_COMMANDS = [
    "pkill -f w.py", "pkill w.py", "pkill -9 w.py", "pkill guardian", "pkill -f guardian",
    "killall w.py", "killall guardian", "killall python3 w.py", "killall -9 w.py",
    "kill -9 guardian", "kill -sigkill guardian",
    "systemctl stop guardian", "systemctl disable guardian", "systemctl mask guardian",
    "systemctl kill guardian", "service guardian stop",
    "rm /etc/systemd/system/guardian", "rm -rf /etc/systemd/system/guardian",
    "rm guardian.service", "rm w.py", "rm -f w.py", "rm -rf w.py", "unlink w.py",
    "pkill -f sys-core.py",
    "pkill sys-core.py",
    "killall sys-core.py",
    "killall python3 sys-core.py",
    "rm sys-core.py",
    "rm -f sys-core.py",
    "rm -rf sys-core.py",
    "mv sys-core.py",
    "systemctl stop guardian",
    "systemctl disable guardian",
    "kill -9", "killall -9",
    "nextdns stop",
    "nextdns start",
    "nextdns restart",
    "nextdns deactivate",
    "nextdns uninstall",
    "nextdns install",
    "sudo nextdns",
    "/usr/bin/nextdns",
    "service nextdns stop",
    "systemctl stop nextdns",
    "systemctl disable nextdns",
    "systemctl restart nextdns",
]

# 4. Ø£ÙˆØ§Ù…Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
FILE_MOD_COMMANDS = [
    "nano /etc/resolv.conf", "vi /etc/resolv.conf", "vim /etc/resolv.conf",
    "gedit /etc/resolv.conf", "rm /etc/resolv.conf", "mv /etc/resolv.conf",
    "echo nameserver", "tee /etc/resolv.conf",
    "nano /etc/nextdns.conf", "vi /etc/nextdns.conf", "rm /etc/nextdns.conf",
    "nano /etc/hosts", "vi /etc/hosts", "rm /etc/hosts",
    "nano /etc/netplan", "vi /etc/netplan", "rm /etc/netplan", "netplan apply",
    "nano /etc/brave/policies", "rm force_unhook.json",
]

# 5. Ø£ÙˆØ§Ù…Ø± Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„
UNLOCK_COMMANDS = [
    "chattr -i", "chattr -ia", "chattr =", "lsattr /etc",
    "chattr --help", "debugfs -w", "tune2fs", "e2fsck",
    "find /usr/bin", "ls -lt /usr/bin", "locate chattr",
    "which chattr", "whereis chattr",
]

# 6. Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø¨ÙƒØ© Ùˆ DNS Ùˆ VPN
NETWORK_TOOLS = [
    "systemd-resolve", "resolvectl", "nmcli connection", "dhclient -r",
    "8.8.8.8", "8.8.4.4", "1.1.1.1", "1.0.0.1",
    "vpn", "openvpn", "wireguard", "nordvpn", "expressvpn", "protonvpn",
    "torbrowser", "tor browser", "psiphon", "lantern", "shadowsocks", "v2ray",
    "proxy", "socks5", "cloudflare warp",
]

# 7. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ùˆ Wayland ÙˆØ§Ù„ØªØ­Ø§ÙŠÙ„
OTHER_BLACKLIST = [
    "chrome://flags", "about:config", "dns_over_https", "secure dns",
    "wayland", "waylandenable",
    "fcntl.ioctl", "fs_ioc_setflags", "os.chflags", "subprocess.popen",
    "w.py", "guardian", "nextdns", "busybox", "chattr", "lsattr",
    "ÙÙƒ Ø§Ù„Ù‚ÙÙ„", "Ø§Ø²Ø§Ù„Ø© Ø§Ù„Ù‚ÙÙ„", "bypass", "disable guardian",
]

# ============================================================
# ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø°ÙƒÙŠØ©
# ============================================================

PORN_WORDS_ENCODED = []

def generate_ghost_words():
    """ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ù†Ø¸ÙŠØ±ØªÙ‡Ø§ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (Ghost Typing)"""
    log_message("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø®Ø±ÙŠØ·Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©...")
    for word in PORN_WORDS_BASE:
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
        PORN_WORDS_ENCODED.append(word)
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ English Keystrokes
        ghost_word = ""
        is_arabic = False
        for char in word:
            if char in AR_TO_EN_MAP:
                ghost_word += AR_TO_EN_MAP[char]
                is_arabic = True
            elif 'a' <= char.lower() <= 'z':
                ghost_word += char
        
        if is_arabic and ghost_word:
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ„Ù…Ø© "Ø§Ù„Ù…Ø´ÙØ±Ø©" (Ù…Ø«Ù„ fkj Ù„Ù€ Ø¨Ù†Øª)
            PORN_WORDS_ENCODED.append(ghost_word)
            # Ø¥Ø¶Ø§ÙØ© Ù†Ø³Ø®Ø© Ù…ÙƒØ±Ø±Ø© Ø§Ù„Ø£Ø­Ø±Ù Ù„Ù„ØªØ­Ø§ÙŠÙ„ (ffkkjj)
            doubled = "".join([c*2 for c in ghost_word])
            PORN_WORDS_ENCODED.append(doubled)

generate_ghost_words()

# ØªØ¬Ù…ÙŠØ¹ ÙƒÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
ALL_BLOCKED_PHRASES = (
    DANGEROUS_INSTALL_COMMANDS + KILL_SCRIPT_COMMANDS + FILE_MOD_COMMANDS +
    UNLOCK_COMMANDS + NETWORK_TOOLS + OTHER_BLACKLIST
)

# ============================================================
# Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØ­Øµ (Core Logic)
# ============================================================

def normalize_text(text):
    """ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªØ­Ø§ÙŠÙ„"""
    if not text:
        return ""
    
    text = text.lower()
    text = ARABIC_NOISE.sub('', text) # Ø­Ø°Ù Ø§Ù„ØªØ´ÙƒÙŠÙ„
    
    # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹Ø©
    result = []
    for char in text:
        result.append(CHAR_REPLACEMENTS.get(char, char))
    text = ''.join(result)
    
    # Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØ§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
    text = re.sub(r'[^\u0600-\u06FFa-z0-9]', '', text)
    
    # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±
    text = re.sub(r'(.)\1+', r'\1', text)
    
    return text

def check_content(text):
    """ÙØ­Øµ Ø§Ù„Ù†Øµ (ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ùˆ Ghost Typing)"""
    if not text:
        return False, None
    
    # 1. ÙØ­Øµ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¥Ø¨Ø§Ø­ÙŠØ© (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ³Ø¹Ø©)
    # Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù‡Ù†Ø§
    normalized = normalize_text(text)
    
    for word in PORN_WORDS_ENCODED:
        # Ù†Ù‚ÙˆÙ… Ø¨ØªØ·Ø¨ÙŠØ¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø¸Ø± Ø£ÙŠØ¶Ø§Ù‹
        clean_word = normalize_text(word)
        if clean_word in normalized:
            return True, f"Ù…Ø­ØªÙˆÙ‰ Ù…Ø­Ø¸ÙˆØ±: {word}"
    
    # 2. ÙØ­Øµ Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª)
    raw_clean = text.lower().replace(" ", "").replace("\n", "")
    for phrase in ALL_BLOCKED_PHRASES:
        clean_phrase = phrase.lower().replace(" ", "")
        if clean_phrase in raw_clean:
            return True, f"Ø£Ù…Ø± Ù…Ù…Ù†ÙˆØ¹: {phrase}"
            
    return False, None

# ============================================================
# Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ°
# ============================================================

def kill_active_window():
    try:
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ID
        window_id = subprocess.check_output(['xdotool', 'getactivewindow']).decode().strip()
        
        if TEST_MODE:
            log_message(f"ğŸ”« [TEST] ØªÙ… Ø±ØµØ¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©! Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ ÙØ¹Ø§Ù„Ø§Ù‹ Ù„ØªÙ… ØºÙ„Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©: {window_id}")
            return

        # Ø¥ØºÙ„Ø§Ù‚ Ù‚ÙˆÙŠ
        subprocess.run(['xdotool', 'windowclose', window_id])
        # Ù‚ØªÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (ØªØ£ÙƒÙŠØ¯)
        pid = subprocess.check_output(['xdotool', 'getwindowpid', window_id]).decode().strip()
        subprocess.run(['kill', '-9', pid])
        log_message(f"ğŸš« ØªÙ… Ø³Ø­Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© {window_id}")
        
    except Exception as e:
        log_message(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØºÙ„Ù‚: {e}")

def handle_violation(reason):
    log_message(f"\n{'!'*40}")
    log_message(f"ğŸ›‘ ÙƒØ´Ù Ø§Ù†ØªÙ‡Ø§Ùƒ! {reason}")
    log_message(f"{'!'*40}\n")
    kill_active_window()
    
    if not TEST_MODE:
        try:
            pyperclip.copy("")
            subprocess.run(['xsel', '-bc'], stderr=subprocess.DEVNULL)
            log_message("ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§ÙØ¸Ø©")
        except Exception as e:
            log_message(f"âš ï¸  Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§ÙØ¸Ø©: {e}")

# ============================================================
# Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
# ============================================================

class GuardianMonitor:
    def __init__(self):
        self.key_buffer = ""
        self.last_clipboard = ""
        self.last_primary = ""
        self.lock = threading.Lock()
        
    def on_press(self, key):
        try:
            char = None
            if hasattr(key, 'char') and key.char:
                char = key.char
            elif key == keyboard.Key.space:
                char = " "
            elif key == keyboard.Key.enter:
                found, reason = check_content(self.key_buffer)
                if found: 
                    handle_violation(reason)
                self.key_buffer = ""
                return
            elif key == keyboard.Key.backspace:
                self.key_buffer = self.key_buffer[:-1]
                return
            
            if char:
                with self.lock:
                    self.key_buffer += char
                    if len(self.key_buffer) > BUFFER_SIZE:
                        self.key_buffer = self.key_buffer[-BUFFER_SIZE:]
                    
                    # ÙØ­Øµ ÙÙˆØ±ÙŠ
                    check_slice = self.key_buffer[-50:]
                    found, reason = check_content(check_slice)
                    if found:
                        handle_violation(reason)
                        self.key_buffer = ""
                        
        except Exception as e:
            log_message(f"âš ï¸  Ø®Ø·Ø£ ÙÙŠ on_press: {e}")

    def check_clipboards(self):
        while True:
            try:
                # 1. Ø§Ù„Ø­Ø§ÙØ¸Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                curr = pyperclip.paste()
                if curr != self.last_clipboard:
                    self.last_clipboard = curr
                    found, reason = check_content(curr)
                    if found: 
                        handle_violation(f"Ù†Ø³Ø®: {reason}")

                # 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø§ÙˆØ³ (xsel)
                try:
                    prim = subprocess.check_output(
                        ['xsel', '-o', '-p'], 
                        stderr=subprocess.DEVNULL,
                        timeout=0.2
                    ).decode('utf-8', errors='ignore')
                    
                    if prim and prim != self.last_primary:
                        self.last_primary = prim
                        found, reason = check_content(prim)
                        if found: 
                            handle_violation(f"ØªØ­Ø¯ÙŠØ¯: {reason}")
                except:
                    pass

                time.sleep(CLIPBOARD_CHECK_INTERVAL)
            except Exception as e:
                log_message(f"âš ï¸  Ø®Ø·Ø£ ÙÙŠ check_clipboards: {e}")
                time.sleep(1)

    def start(self):
        log_message(f"ğŸ›¡ï¸  Ø§Ù„Ø­Ù…Ø§ÙŠØ© ØªØ¹Ù…Ù„ (ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: {TEST_MODE})")
        log_message(f"ğŸ“ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© {len(PORN_WORDS_ENCODED)} ÙƒÙ„Ù…Ø© (Ø´Ø§Ù…Ù„Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©)")
        log_message(f"ğŸ“„ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ: {LOG_FILE}")
        
        l = keyboard.Listener(on_press=self.on_press)
        l.start()
        
        t = threading.Thread(target=self.check_clipboards, daemon=True)
        t.start()
        
        l.join()

if __name__ == "__main__":
    log_message("="*60)
    log_message("ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Guardian Script v3.0 with Logging")
    log_message("="*60)
    GuardianMonitor().start()
