#!/usr/bin/env python3
"""
DNS Settings Guard - Ù†Ø³Ø®Ø© Ø§Ù„Ø¨Ø±Ù‚
ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ§Ù„Ø´Ø¨ÙƒØ©
ØªØ´ØºÙŠÙ„: python3 dns_guard.py
"""

import subprocess
import time
import sys

CHECK_INTERVAL = 0.5

BLOCKED_FRAGMENTS = [
    "MiuiWirelessSettings",
    "PrivateDnsSettings",
    "DnsSettings",
]

def adb(cmd: list, timeout=5) -> str:
    result = subprocess.run(["adb"] + cmd, capture_output=True, timeout=timeout)
    return result.stdout.decode(errors="ignore")

def check_adb():
    out = adb(["devices"])
    lines = [l for l in out.strip().splitlines() if "device" in l and "List" not in l]
    if not lines:
        print("âŒ  Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ù‡Ø§Ø² Ù…ØªØµÙ„!")
        sys.exit(1)
    print(f"âœ…  Ø¬Ù‡Ø§Ø² Ù…ØªØµÙ„: {lines[0].split()[0]}")

def is_blocked() -> tuple:
    out = adb(["shell", "dumpsys", "activity", "top"])
    for fragment in BLOCKED_FRAGMENTS:
        if fragment in out:
            return True, fragment
    return False, ""

def go_back():
    adb(["shell", "input", "keyevent", "KEYCODE_BACK"])

def main():
    print("=" * 50)
    print("    ğŸ”’  DNS Settings Guard  ğŸ”’")
    print("=" * 50)

    check_adb()

    print(f"\n Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©:")
    for f in BLOCKED_FRAGMENTS:
        print(f"   ğŸš« {f}")
    print(f"\nğŸš€  Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©... Ctrl+C Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù\n")

    count = 0

    try:
        while True:
            t0 = time.time()
            blocked, fragment = is_blocked()
            count += 1

            if blocked:
                print(f"\nğŸš«  Ù…Ø­Ø¸ÙˆØ±! ({fragment}) â†’ Ø±Ø¬ÙˆØ¹")
                go_back()
                time.sleep(0.5)
            else:
                sys.stdout.write(f"\râœ…  Ø¢Ù…Ù† | #{count}   ")
                sys.stdout.flush()

            time.sleep(max(0, CHECK_INTERVAL - (time.time() - t0)))

    except KeyboardInterrupt:
        print(f"\n\nâ¹ï¸  ØªÙˆÙ‚ÙØª. ÙØ­ÙˆØµØ§Øª: {count}")

if __name__ == "__main__":
    main()
